---
- name: Install podman
  tags: packages
  become: true
  ansible.builtin.package:
    name: podman
    state: present

- name: Create config directory
  tags: config
  become: true
  ansible.builtin.file:
    path: "{{ copyparty_config_dir }}"
    state: directory
    owner: podman
    group: podman
    mode: '0755'

- name: Create shared directories
  tags: config
  become: true
  ansible.builtin.file:
    path: "{{ item.host_path }}"
    state: directory
    owner: podman
    group: podman
    mode: '0755'
  loop: "{{ copyparty_volumes }}"

- name: Deploy copyparty config
  tags: config
  become: true
  ansible.builtin.template:
    src: copyparty.conf.j2
    dest: "{{ copyparty_config_dir }}/copyparty.conf"
    owner: podman
    group: podman
    mode: '0644'
  notify: Restart copyparty

- name: Create container systemd unit file directory
  tags: container
  become: true
  ansible.builtin.file:
    path: "/etc/containers/systemd"
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Deploy shared web-services network definition
  tags: container
  become: true
  ansible.builtin.copy:
    src: web-services.network  # file comes from common role
    dest: /etc/containers/systemd/web-services.network
    owner: root
    group: root
    mode: '0644'
  when: copyparty_reverse_proxy
  notify: Restart copyparty

- name: Deploy copyparty container definition
  tags: container
  become: true
  ansible.builtin.template:
    src: copyparty.container.j2
    dest: /etc/containers/systemd/copyparty.container
    owner: root
    group: root
    mode: '0644'
  notify: Restart copyparty
